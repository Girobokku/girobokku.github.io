<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuenta atrás</title>
  <meta name="description" content="Invitación de boda de Silvia y Alberto" />
  <style>
    :root{
      --bg: #0f172a;
      --fg: #e2e8f0;
      --muted: #94a3b8;
      --card: #111827;
      --accent: #22d3ee;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--fg);
      background: radial-gradient(1200px 800px at 70% 30%, #1f2937, var(--bg));
      display:grid; place-items:center;
    }
    main{width:min(100%, 900px); padding:24px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:24px; padding:32px; box-shadow:0 20px 50px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      display:flex; flex-direction:column; align-items:center;
    }
    h1{margin:0 0 10px; font-weight:800; letter-spacing:0.5px}
    .sub{color:var(--muted); margin:0 0 24px}
    .grid{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:14px}
    .tile{display:flex; flex-direction:column; align-items:center; padding:18px; background:var(--card); border-radius:18px; border:1px solid rgba(255,255,255,0.06)}
    .num{font-variant-numeric: tabular-nums; font-size: clamp(32px, 8vw, 64px); font-weight:900; line-height:1}
    .label{margin-top:6px; color:var(--muted); font-size:14px; letter-spacing:1px; text-transform:uppercase}
    .hidden{display:none !important}
    .reveal{display:flex; justify-content:center; align-items:center; padding:8px;}
    .reveal img{max-width:100%; height:auto; border-radius:20px; box-shadow:0 12px 40px rgba(0,0,0,.35)}
    @media (max-width:520px){
      .grid{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
  </style>
  <style>
    /* Lienzo para fuegos artificiales */
    .fx{position:fixed; inset:0; pointer-events:none; z-index:999}
  </style>
</head>
<body>
  <main>
    <section id="countdown-card" class="card" aria-live="polite">
      <h1 id="headline">Revelación a las <span id="target-text">22:30</span></h1>
      <p id="helper" class="sub">Faltan…</p>
      <div class="grid" role="timer" aria-atomic="true" aria-live="polite">
        <div class="tile"><div class="num" id="d">0</div><div class="label">días</div></div>
        <div class="tile"><div class="num" id="h">0</div><div class="label">horas</div></div>
        <div class="tile"><div class="num" id="m">0</div><div class="label">minutos</div></div>
        <div class="tile"><div class="num" id="s">0</div><div class="label">segundos</div></div>
      </div>
    </section>

    <section id="reveal-card" class="card reveal hidden">
      <div id="image-wrap"><img id="reveal-image" alt="Imagen revelada" loading="lazy" /></div>
    </section>

    <noscript>
      <p>Necesitas JavaScript para ver la cuenta atrás.</p>
    </noscript>
  </main>
  <!-- Canvas de efectos -->
  <canvas id="fx" class="fx"></canvas>

  <script>
    // === CONFIGURACIÓN RÁPIDA ===
    const CONFIG = {
      horaObjetivo: "22:00",            // hora de revelación (HH:MM formato 24h)
      mensajeAntes: "Revelación a las", // texto antes de la hora
      imagen: "img.jpg"                 // imagen a mostrar (se carga solo al revelar)
    };

    // === CÁLCULO DE FECHA OBJETIVO ===
    const [HH, MM] = CONFIG.horaObjetivo.split(":").map(Number);
    const now = new Date();
    const targetDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), HH, MM, 0, 0);

    // Encabezado dinámico
    document.getElementById('headline').innerHTML = `${CONFIG.mensajeAntes} <span id="target-text">${CONFIG.horaObjetivo}</span>`;

    // Referencias de elementos
    const $d = document.getElementById('d');
    const $h = document.getElementById('h');
    const $m = document.getElementById('m');
    const $s = document.getElementById('s');

    const $countdownCard = document.getElementById('countdown-card');
    const $revealCard = document.getElementById('reveal-card');
    const $revealImg = document.getElementById('reveal-image');
    const helper = document.getElementById('helper');

    // Utilidades
    function pad(n){ return String(n).padStart(2,'0'); }
    function breakdown(ms){
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const days = Math.floor(totalSeconds / 86400);
      const hours = Math.floor((totalSeconds % 86400) / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return {days, hours, minutes, seconds};
    }

    // Render loop
    function updateCountdown(){
      const diff = targetDate.getTime() - Date.now();
      if (diff <= 0){
        reveal();
        return;
      }
      const {days, hours, minutes, seconds} = breakdown(diff);
      $d.textContent = days;
      $h.textContent = pad(hours);
      $m.textContent = pad(minutes);
      $s.textContent = pad(seconds);
    }

    function reveal(){
      // Cargar la imagen justo ahora (evita que se descargue antes)

    }

    /*
function reveal(){
      // Cargar la imagen justo ahora (evita que se descargue antes)
      if(!$revealImg.getAttribute('src')){ $revealImg.src = CONFIG.imagen; }
      $countdownCard.classList.add('hidden');
      $revealCard.classList.remove('hidden');
      startFireworks(5000); // 5 segundos de fuegos artificiales
      if (timerId) clearInterval(timerId);
    }
    */

    // Inicio
    let timerId = null;
    if (Date.now() >= targetDate.getTime()){
      reveal();
    } else {
      updateCountdown();
      timerId = setInterval(updateCountdown, 1000);
    }

    // Accesibilidad: resumen cada 10s
    let a11yTick = 0;
    const a11yInterval = setInterval(() => {
      a11yTick++;
      if ($countdownCard.classList.contains('hidden')){ clearInterval(a11yInterval); return; }
      const d = Number($d.textContent), h=Number($h.textContent), m=Number($m.textContent), s=Number($s.textContent);
      helper.textContent = `Faltan ${d} día${d!==1?'s':''}, ${h} hora${h!==1?'s':''}, ${m} minuto${m!==1?'s':''} y ${s} segundo${s!==1?'s':''}.`;
    }, 10000);

    // === Fuegos artificiales ===
    const fxCanvas = document.getElementById('fx');
    const ctx = fxCanvas.getContext('2d');
    let particles = [], animId=null, running=false;

    function resizeFx(){ fxCanvas.width = innerWidth; fxCanvas.height = innerHeight; }
    addEventListener('resize', resizeFx); resizeFx();

    function rand(min, max){ return Math.random() * (max - min) + min; }
    function hsl(h, s, l){ return `hsl(${h} ${s}% ${l}%)`; }

    function spawnBurst(x, y){
      const hue = rand(0,360);
      const count = 60;
      for(let i=0;i<count;i++){
        const angle = (i / count) * Math.PI * 2;
        const speed = rand(1.5, 4.5);
        particles.push({
          x, y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          life: rand(40,70),
          alpha: 1,
          color: hsl(hue + rand(-20,20), 80, 60)
        });
      }
    }

    function animate(){
      ctx.clearRect(0,0,fxCanvas.width, fxCanvas.height);
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.vy += 0.03; // gravedad suave
        p.x += p.vx; p.y += p.vy;
        p.life -= 1; p.alpha -= 0.012;
        if(p.life <= 0 || p.alpha <= 0 || p.y>fxCanvas.height){ particles.splice(i,1); continue; }
        ctx.globalAlpha = Math.max(p.alpha, 0);
        ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fillStyle = p.color; ctx.fill();
      }
      if(running || particles.length){ animId = requestAnimationFrame(animate); }
    }

    function startFireworks(durationMs=4000){
      if(animId) cancelAnimationFrame(animId);
      running = true;
      const start = performance.now();
      (function loop(t){
        if(t - start < durationMs){
          const x = rand(fxCanvas.width*0.15, fxCanvas.width*0.85);
          const y = rand(fxCanvas.height*0.15, fxCanvas.height*0.55);
          spawnBurst(x, y);
          setTimeout(()=>loop(performance.now()), rand(200, 450));
        } else {
          running = false;
        }
      })(start);
      animate();
      // auto limpiar después
      setTimeout(()=>{ running=false; }, durationMs + 1200);
    }

    // === "Tests" básicos para depurar (actívalos con ?test=1 en la URL) ===
    try {
      const qs = new URLSearchParams(location.search);
      if (qs.get('test') === '1'){
        console.log('%c[TEST] Iniciando pruebas…','color:#22d3ee');
        console.assert(pad(5)==='05', 'pad(5) debe ser "05"');
        console.assert(pad(12)==='12', 'pad(12) debe ser "12"');
        const sample = breakdown((1*86400 + 2*3600 + 3*60 + 4)*1000);
        console.assert(sample.days===1 && sample.hours===2 && sample.minutes===3 && sample.seconds===4, 'breakdown incorrecto');
        const t = new Date();
        const td = new Date(t.getFullYear(), t.getMonth(), t.getDate(), HH, MM, 0, 0);
        console.assert(td.getHours()===HH && td.getMinutes()===MM, 'targetDate con hora/min incorrectos');
        console.log('%c[TEST] OK','color:#16a34a');
      }
    } catch(e){ console.warn('Tests no ejecutados:', e); }
  </script>
</body>
</html>
